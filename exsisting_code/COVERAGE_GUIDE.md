# カバレッジレポートの読み方ガイド

## レポートの構成

カバレッジレポートは以下の情報を含みます：

### 1. 要素カバレッジ

```
【要素カバレッジ】
  XSDで定義された要素パス数: 313
  ├─ XMLで使用されている数: 312
  └─ XMLで未使用の数: 1
  
  XMLに存在する要素パス総数: 3,556
  ├─ XSDで定義済み: 312
  └─ XSDで未定義: 3,244
  
  カバレッジ率: 99.68%
  （定義された313個のうち312個が使用されている）
```

#### 意味の解説

- **XSDで定義された要素パス数**: XSDスキーマで定義されているすべての要素パスの数
  - これには`minOccurs="0"`のオプショナルな要素も含まれます
  
- **XMLで使用されている数**: 定義されたパスのうち、実際にXMLファイル群で使用されている数
  
- **XMLで未使用の数**: 定義されているが、XMLファイル群では一度も使用されていないパスの数
  - テストデータで網羅できていない部分
  
- **XMLに存在する要素パス総数**: XMLファイル群に実際に存在するすべての要素パスの数
  - これは定義されたパスと未定義のパスの両方を含みます
  
- **XSDで定義済み**: XMLに存在するパスのうち、XSDで定義されているもの
  
- **XSDで未定義**: XMLに存在するが、XSDで定義されていないパス
  - **これが0より大きい場合、XMLがXSDに準拠していない可能性があります**
  
- **カバレッジ率**: 定義されたパスのうち、使用されているパスの割合
  - 計算式: (使用されている数 / 定義された数) × 100

### 2. 属性カバレッジ

属性についても要素と同じ構造で情報が表示されます。

```
【属性カバレッジ】
  XSDで定義された属性パス数: 572
  ├─ XMLで使用されている数: 570
  └─ XMLで未使用の数: 2
  
  XMLに存在する属性パス総数: 12,185
  ├─ XSDで定義済み: 570
  └─ XSDで未定義: 11,615
  
  カバレッジ率: 99.65%
  （定義された572個のうち570個が使用されている）
```

属性の場合も、`use="optional"`の属性が定義数に含まれます。

### 3. 総合カバレッジ

要素と属性を合わせた全体のカバレッジです。

```
【総合カバレッジ】
  XSDで定義された総パス数: 885
  ├─ XMLで使用されている数: 882
  └─ XMLで未使用の数: 3
  
  XMLに存在する総パス数: 15,741
  ├─ XSDで定義済み: 882
  └─ XSDで未定義: 14,859
  
  カバレッジ率: 99.66%
  （定義された885個のうち882個が使用されている）
```

## 典型的なケース分析

### ケース1: 正常なカバレッジ

```
XSDで定義された要素パス数: 56
XMLに存在する要素パス総数: 20
XSDで未定義: 0
カバレッジ率: 35.71%
```

**解釈**: 
- XMLはXSDに完全に準拠している（未定義パス = 0）
- 定義された56個のパスのうち、20個（35.71%）がテストでカバーされている
- 残り36個のパスはテストデータで使用されていない

**アクション**: 
- カバレッジを上げたい場合、未使用のパスを含むテストXMLを追加

### ケース2: あなたのような異常なケース

```
XSDで定義された要素パス数: 313
XMLに存在する要素パス総数: 3,556
XSDで未定義: 3,244
カバレッジ率: 99.68%
```

**解釈**: 
- XMLに3,244個もの未定義パスが存在している（問題！）
- 定義されたパスのカバレッジは高い（99.68%）が...
- XMLの大部分（91.2%）がXSDで定義されていないパスで構成されている

**考えられる原因**: 
1. **XSDの解析が不完全** - プログラムがXSDの一部を正しく解析できていない
2. **XMLがXSDに準拠していない** - XMLに余分な要素・属性が大量に含まれている
3. **名前空間の不一致** - XMLとXSDで名前空間が異なっている
4. **動的に生成される要素** - XMLに動的な要素名が含まれている

**アクション**: 
1. 「警告: XSDで定義されていない要素パス」セクションを確認
2. サンプルの未定義パスを見て、パターンを特定
3. XSDの解析ロジックを確認するか、XMLの構造を検証

### ケース3: 低カバレッジ

```
XSDで定義された要素パス数: 313
XMLで使用されている数: 50
XSDで未定義: 0
カバレッジ率: 15.97%
```

**解釈**: 
- XMLはXSDに準拠している（未定義パス = 0）
- しかし、定義された313個のうち50個（16%）しか使用されていない
- テストデータが不十分

**アクション**: 
- 未使用のパスを含む追加のテストXMLを作成
- 特に、オプショナルな要素や条件分岐のパスを網羅する

### ケース4: 100%カバレッジ

```
XSDで定義された要素パス数: 313
XMLで使用されている数: 313
XSDで未定義: 0
カバレッジ率: 100.00%
```

**解釈**: 
- 完璧！すべての定義されたパスがテストでカバーされている
- XMLはXSDに完全に準拠している

**注意**: 
- 100%でも、各パスの値のバリエーションは別問題
- 各要素の異なる値や属性の組み合わせも考慮する必要がある

## 警告セクションの重要性

### 「XSDで定義されていない要素パス」

これが表示される場合、以下のいずれかの問題があります：

1. **XMLがXSDに準拠していない**
   - XMLに余分な要素が含まれている
   - タイポや命名ミス
   
2. **XSDの解析に問題がある**
   - プログラムが複雑なXSD構造を正しく処理できていない
   - 名前空間の扱いに問題がある
   - `xsd:choice`や`xsd:any`などの特殊な構造

3. **名前空間の不一致**
   - XMLとXSDで異なる名前空間を使用している
   - プレフィックスが異なる

### デバッグ方法

```bash
# 1. 未定義パスのサンプルを確認
grep "警告: XSDで定義されていない要素パス" coverage_report.txt -A 10

# 2. パターンを特定
# 例: すべてのパスが特定のプレフィックスで始まっている → 名前空間の問題
# 例: 特定の親要素の下だけに集中している → その型定義の解析に問題

# 3. XSDファイルで該当要素の定義を確認
grep -n "element name=\"要素名\"" schema.xsd
```

## カバレッジ向上のヒント

1. **未使用のパスを確認**
   - 「未使用の要素パス」セクションを参照
   - これらを含むテストXMLを追加

2. **階層のバリエーションを増やす**
   - 同じ要素名でも、異なる階層で使う
   - 再帰的な構造（ネスト）を深くテスト

3. **オプショナル要素を含める**
   - `minOccurs="0"`の要素も意識的にテスト
   - `use="optional"`の属性も使用する

4. **境界値をテスト**
   - `maxOccurs="unbounded"`の要素を複数個配置
   - 異なる属性値の組み合わせを試す

## 実用的な活用例

### テストケース設計

```
現在のカバレッジ: 40%
目標: 80%以上

手順:
1. 未使用のパス一覧から、重要度の高いものを選定
2. それらを含むXMLを作成
3. カバレッジを再計測
4. 目標達成まで繰り返し
```

### XSD検証

```
予期しない結果:
- カバレッジ率: 99%
- 未定義パス: 3,000個以上

調査:
1. 未定義パスのパターンを確認
2. XSDの該当部分を特定
3. プログラムのXSD解析ロジックを確認
4. 必要に応じてXSDを修正
```

### リグレッションテスト

```
定期的にカバレッジを計測:
- 週次: XMLサンプルセット全体でカバレッジ計測
- カバレッジ低下 → 新しいXSDの変更がテストされていない
- 未定義パス増加 → XMLがXSDと乖離している
```

## よくある質問

### Q1: カバレッジは何%を目指すべき？

A: プロジェクトによりますが：
- **最低限**: 60-70%（主要パスのみ）
- **推奨**: 80-90%（ほぼすべての重要パス）
- **理想**: 95%以上（網羅的テスト）
- **100%**: 必ずしも必要ではない（稀なエッジケースも含むため）

### Q2: オプショナルな要素もカバーすべき？

A: はい、特に：
- ビジネスロジックに影響する要素
- エラー処理に関わる要素
- 互換性維持のための要素

### Q3: 未定義パスが大量にある場合、どうすれば？

A: 
1. まず、サンプルのパスを5-10個確認
2. パターンを特定（名前空間？特定の親要素？）
3. XSDファイルで該当箇所を確認
4. プログラムのデバッグ出力を有効にして詳細を調査

### Q4: 階層構造のカウントは正しい？

A: 
- 同じ要素名でも、異なる階層では別パスとしてカウント
- 例: `/A/B/C` と `/A/D/C` は別パス
- これは意図的な設計（階層ごとに異なる意味を持つため）
